- hosts: nodes
  user: root
  vars:
    MasterConfigFile: /etc/origin/master/master-config.yaml
    imageProvenancePluginFile: image-Provenance-plugin.template
  tasks:
   - name: Check existence of master config file {{ MasterConfigFile }}
     stat:
       path: '{{ MasterConfigFile }}'
     register: masterconfig_file

   - name: remove the existing ImagePolicy section
     replace:
       path: '{{ MasterConfigFile }}'
       regexp: '^(\s+).openshift.io/ImagePolicy:(.*\n)*(\s+).kind: ImagePolicyConfig$(.*\n)'
     when: masterconfig_file.stat.exists

   - name: Configure Image Provenance Plugin in {{ MasterConfigFile }} for TSS 9.7
     blockinfile:
       path: '{{ MasterConfigFile }}'
       insertafter: "pluginConfig:"
       block: "{{ lookup('template', '{{ imageProvenancePluginFile }}') }}"
       marker: "# {mark} ANSIBLE MANAGED BLOCK - Image-Provenance-plugin section"
       state: present
     when: masterconfig_file.stat.exists
